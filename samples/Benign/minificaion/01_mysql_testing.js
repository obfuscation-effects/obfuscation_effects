var pool=require("generic-pool"),mysql=require("mysql"),async=require("async"),host="localhost",database="PhotoAlbums",user="root",password="",dbclient;
async.waterfall([function(b){console.log("\n** 1. create connection.");dbclient=mysql.createConnection({host:"localhost",user:"root",password:"",database:"PhotoAlbums"});dbclient.connect(b)},function(b,a){console.log("\n** 2. create albums.");dbclient.query("INSERT INTO Albums VALUES (?, ?, ?, ?)",["italy2012","Spring Festival in Italy","2012-02-15","I went to Italy for Spring Festival"],a)},function(b,a,c){console.log(arguments);console.log(a);console.log("\n** 2b. create albums.");dbclient.query("INSERT INTO Albums VALUES (?, ?, ?, ?)",
["australia2010","Vacation Down Under","2010-10-20","Spent some time in Australia visiting Friends"],c)},function(b,a,c){console.log(a);console.log("\n** 2c. create albums.");dbclient.query("INSERT INTO Albums VALUES (?, ?, ?, ?)",["japan2010","Programming in Tokyo","2010/06/10","I worked in Tokyo for a while."],c)},function(b,a,c){console.log(a);console.log("\n** 3. Add pictures.");async.forEachSeries([{filename:"picture_01.jpg",albumid:"italy2012",description:"rome!",date:"2012/02/15 16:20:40"},
{filename:"picture_04.jpg",albumid:"italy2012",description:"fontana di trevi",date:"2012/02/19 16:20:40"},{filename:"picture_02.jpg",albumid:"italy2012",description:"it's the vatican!",date:"2012/02/17 16:35:04"},{filename:"picture_05.jpg",albumid:"italy2012",description:"rome!",date:"2012/02/19 16:20:40"},{filename:"picture_03.jpg",albumid:"italy2012",description:"spanish steps",date:"2012/02/18 16:20:40"},{filename:"photo_05.jpg",albumid:"japan2010",description:"something nice",date:"2010/06/14 12:21:40"},
{filename:"photo_01.jpg",albumid:"japan2010",description:"tokyo tower!",date:"2010/06/11 12:20:40"},{filename:"photo_06.jpg",albumid:"japan2010",description:"kitty cats",date:"2010/06/14 12:23:40"},{filename:"photo_03.jpg",albumid:"japan2010",description:"shinjuku is nice",date:"2010/06/12 08:80:40"},{filename:"photo_04.jpg",albumid:"japan2010",description:"eating sushi",date:"2010/06/12 08:34:40"},{filename:"photo_02.jpg",albumid:"japan2010",description:"roppongi!",date:"2010/06/12 07:44:40"},{filename:"photo_07.jpg",
albumid:"japan2010",description:"moo cow oink pig woo!!",date:"2010/06/15 12:55:40"},{filename:"photo_001.jpg",albumid:"australia2010",description:"sydney!",date:"2010/10/20 07:44:40"},{filename:"photo_002.jpg",albumid:"australia2010",description:"asdfasdf!",date:"2010/10/20 08:24:40"},{filename:"photo_003.jpg",albumid:"australia2010",description:"qwerqwr!",date:"2010/10/20 08:55:40"},{filename:"photo_004.jpg",albumid:"australia2010",description:"zzzxcv zxcv",date:"2010/10/21 14:29:40"},{filename:"photo_005.jpg",
albumid:"australia2010",description:"ipuoip",date:"2010/10/22 19:08:40"},{filename:"photo_006.jpg",albumid:"australia2010",description:"asdufio",date:"2010/10/22 22:15:40"}],function(d,e){dbclient.query("INSERT INTO Photos (filename, album_name, description, date)             VALUES (?, ?, ?, ?)",[d.filename,d.albumid,d.description,d.date],e)},c)},function(b){console.log(arguments);console.log("\n** 4. list albums");dbclient.query("SELECT * FROM Albums ORDER BY date DESC",b)},function(b,a,c){console.log(a);
console.log(" -> dumping albums:");for(a=0;a<b.length;a++)console.log(" -> Album: "+b[a].name+" ("+b[a].date+")");console.log("\n** 5. Find album.");dbclient.query("SELECT * FROM Albums WHERE name = ?",["italy2012"],c)},function(b,a,c){console.log(a);console.log(" -> dumping italy2012:");for(a=0;a<b.length;a++)console.log(" -> Album: "+b[a].name+" ("+b[a].date+")");console.log("\n** 6. Photos for albums.");dbclient.query("SELECT * FROM Photos WHERE album_name = ?       ORDER BY date DESC LIMIT ?, ?",
["italy2012",2,5],c)},function(b,a,c){console.log(a);console.log(" -> dumping italy2012 photos:");for(a=0;a<b.length;a++)console.log("Photo: "+b[a].filename+" ("+b[a].date+")");console.log("\n** 7. update photo.");dbclient.query("UPDATE Photos SET description = ?              WHERE album_name = ? AND filename = ?",["NO SHINJUKU! BAD!","italy2012","picture_03.jpg"],c)},function(b,a,c){console.log(a);console.log(b);console.log(" -> updated rows: "+b.affectedRows);1!=b.affectedRows?c(Error("CRAP TEST 7 didn't affect 1 row!")):
(console.log("\n** 8. delete photo."),dbclient.query("DELETE FROM Photos WHERE filename = ? AND album_name = ?",["photo_04.jpg","japan2010"],c))},function(b,a,c){console.log(a);console.log(b);console.log(" -> deleted rows: "+b.affectedRows);1!=b.affectedRows?c(Error("CRAP TEST 8 didn't affect 1 row!")):(console.log("\n** 9. delete entire album and photos"),dbclient.query("DELETE FROM Photos WHERE album_name = ?",["australia2012"],c))},function(b,a,c){console.log(a);console.log(" -> delete photos rows: "+
b.affectedRows);console.log(b);dbclient.query("DELETE FROM Albums WHERE name = ?",["australia2012"],c)},function(b,a,c){console.log(a);console.log(" -> delete album rows: "+b.affectedRows);console.log(b);console.log("\n** 10. Search for non-existant album.");dbclient.query("SELECT * FROM Albums WHERE name = ?",["asdfasdf"],c)},function(b,a,c){console.log(a);console.log(" -> asked for bogus, got "+b.length+" rows");c(null)}],function(b,a){b?(console.log("Aw, there was an error: "),console.log(b)):
console.log("All operations completed without error.");dbclient.end()});
